<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EcoQuest | Sign in / Sign up</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="auth-page">
  <header class="header">
    <div class="container nav">
      <a class="brand" href="index.html">
        <div class="logo"></div>
        <div class="title">EcoQuest</div>
      </a>
      <div class="nav-links">
        <a class="btn ghost" href="leaderboard.html">Leaderboard</a>
        <a class="btn ghost" href="quiz.html">Quizzes</a>
        <a class="btn ghost" href="challenges.html">Challenges</a>
        <a class="btn ghost" href="game.html">Mini Game</a>
        <a class="btn ghost" href="certificate.html">Certificate</a>
        <div id="authButtons" class="nav-links" style="display:none"></div>
        <div id="navUser" class="userbar" style="display:none">
          <img alt="avatar" src=""/>
          <span></span>
          <button id="logoutBtn" class="btn">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <img src="logo.svg" alt="EcoQuest Logo" class="auth-logo">
        <h2 id="auth-title">Welcome to EcoQuest</h2>
        <p id="auth-subtitle">Sign in to continue your eco journey</p>
      </div>

      <div class="auth-toggle-buttons">
        <button id="show-login" class="active">Login</button>
        <button id="show-signup">Sign Up</button>
      </div>

      <!-- Login Form -->
      <form id="login-form" class="auth-form">
        <div class="form-group">
          <label for="login-email">Email Address</label>
          <input type="email" id="login-email" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          <span class="password-toggle">üëÅÔ∏è</span>
        </div>
        <a href="#" class="forgot-password">Forgot your password?</a>
      </form>

      <!-- Sign Up Form -->
      <form id="signup-form" class="auth-form" style="display: none;">
        <div class="form-group">
          <label for="signup-email">Email Address</label>
          <input type="email" id="signup-email" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
          <label for="signup-name">Full Name</label>
          <input type="text" id="signup-name" placeholder="Your full name" required>
        </div>
        <div class="form-group">
          <label for="signup-school">School/College</label>
          <input type="text" id="signup-school" placeholder="Your institution name" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          <span class="password-toggle">üëÅÔ∏è</span>
        </div>
        <div class="form-group">
          <label for="signup-confirm-password">Confirm Password</label>
          <input type="password" id="signup-confirm-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          <span class="password-toggle">üëÅÔ∏è</span>
        </div>
        <button type="submit" class="btn primary auth-btn">Create Account</button>
      </form>

      <div class="auth-divider">
        <span>or continue with</span>
      </div>

      <div class="social-login">
        <button class="btn social-btn google-btn">Continue with Google</button>
        <button class="btn social-btn facebook-btn">Continue with Facebook</button>
      </div>

      <div class="auth-footer">
        <a href="index.html" class="back-to-home">Back to Home</a>
      </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      onAuthStateChanged 
    } from 'firebase/auth';
    import { 
      doc, 
      setDoc, 
      getDoc 
    } from 'firebase/firestore';

    function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
    function validateName(name){ return /^[A-Za-z][A-Za-z\s'.-]{1,48}$/.test(name); }
    function validateSchool(s){ return /^[A-Za-z0-9][A-Za-z0-9\s'.&()-]{2,80}$/.test(s); }

    async function getUserData(uid) {
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        return userDoc.data();
      }
      return null;
    }

    async function createUserProfile(uid, profile) {
      await setDoc(doc(db, 'users', uid), profile);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const showLogin = document.getElementById('show-login');
      const showSignup = document.getElementById('show-signup');
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const authTitle = document.getElementById('auth-title');
      const authSubtitle = document.getElementById('auth-subtitle');

      // Toggle between login and signup forms
      showLogin.addEventListener('click', () => {
        showLogin.classList.add('active');
        showSignup.classList.remove('active');
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
        authTitle.textContent = 'Welcome to EcoQuest';
        authSubtitle.textContent = 'Sign in to continue your eco journey';
      });

      showSignup.addEventListener('click', () => {
        showSignup.classList.add('active');
        showLogin.classList.remove('active');
        signupForm.style.display = 'block';
        loginForm.style.display = 'none';
        authTitle.textContent = 'Join EcoQuest';
        authSubtitle.textContent = 'Create your account and start making a difference';
      });

      // Password toggle functionality
      document.querySelectorAll('.password-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const input = toggle.previousElementSibling;
          if (input.type === 'password') {
            input.type = 'text';
            toggle.textContent = 'üôà';
          } else {
            input.type = 'password';
            toggle.textContent = 'üëÅÔ∏è';
          }
        });
      });

      // Handle login form submission
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim().toLowerCase();
        const password = document.getElementById('login-password').value;

        if (!validateEmail(email)) {
          alert('Please enter a valid email address.');
          return;
        }

        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          const userData = await getUserData(user.uid);
          if (!userData) {
            alert('User profile not found. Please contact support.');
            return;
          }
          const redirect = new URLSearchParams(location.search).get('redirect') || 'dashboard.html';
          window.location.href = redirect;
        } catch (error) {
          alert('Login failed: ' + error.message);
        }
      });

      // Handle signup form submission
      signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('signup-email').value.trim().toLowerCase();
        const name = document.getElementById('signup-name').value.trim();
        const school = document.getElementById('signup-school').value.trim();
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;

        const errors = [];
        if (!validateEmail(email)) errors.push('Enter a valid email.');
        if (!validateName(name)) errors.push('Enter a valid full name.');
        if (!validateSchool(school)) errors.push('Enter a valid school/college name.');
        if (password !== confirmPassword) errors.push('Passwords do not match.');

        if (errors.length) {
          alert(errors.join(' '));
          return;
        }

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          const profile = {
            email,
            name,
            school,
            points: 0,
            badges: [],
            tasksCompleted: {},
            avatarDataUrl: Eco.initialsAvatar(name),
            lastLoginDate: '',
            quizHistory: []
          };
          await createUserProfile(user.uid, profile);
          const redirect = new URLSearchParams(location.search).get('redirect') || 'dashboard.html';
          window.location.href = redirect;
        } catch (error) {
          alert('Signup failed: ' + error.message);
        }
      });
    });
  </script>
</body>
</html>
